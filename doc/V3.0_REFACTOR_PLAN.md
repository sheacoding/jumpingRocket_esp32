# 🚀 蹦跳小火箭 V3.0 重构计划

## 📋 项目概述

基于现有V2.0版本，升级到V3.0版本，主要变化：
- **硬件升级**：从ESP32 DevKit升级到ESP32-C3 Mini
- **存储升级**：从EEPROM升级到SPIFFS/LittleFS文件系统
- **功能增强**：添加深度睡眠、数据历史记录、目标计时等功能
- **架构优化**：为未来Wi-Fi/蓝牙功能预留接口

## 🎯 重构目标

### 核心目标
1. **硬件适配**：完全适配ESP32-C3 Mini开发板
2. **存储系统重构**：实现基于文件系统的数据持久化
3. **功能扩展**：添加V3.0新功能特性
4. **性能优化**：实现低功耗深度睡眠模式
5. **架构升级**：为未来扩展奠定基础

### 技术目标
- ✅ 保持现有功能完整性
- ✅ 提升系统稳定性和性能
- ✅ 增强用户体验
- ✅ 为未来功能扩展预留接口

## 📊 现状分析

### 当前V2.0架构
```
硬件层: ESP32 DevKit + MPU6050 + OLED + 蜂鸣器 + 按钮
驱动层: I2C驱动 + GPIO驱动 + PWM驱动
应用层: 游戏逻辑 + 显示系统 + 音效系统 + 按钮处理
数据层: 内存变量 (无持久化)
```

### 目标V3.0架构
```
硬件层: ESP32-C3 Mini + MPU6050 + OLED + 蜂鸣器 + 按钮 + 锂电池
驱动层: I2C驱动 + GPIO驱动 + PWM驱动 + 文件系统驱动 + 电源管理
应用层: 游戏逻辑 + 显示系统 + 音效系统 + 按钮处理 + 数据管理
数据层: SPIFFS/LittleFS文件系统 + JSON数据格式
扩展层: Wi-Fi接口 + 蓝牙接口 + OTA升级接口 (预留)
```

## 🔧 重构阶段规划

### 阶段1: 硬件适配与基础重构 (1-2周)

#### 1.1 开发板配置更新
- [ ] 更新platformio.ini配置
  - 添加ESP32-C3 Mini专用环境
  - 配置正确的引脚映射
  - 设置编译选项和库依赖

#### 1.2 引脚配置重新映射
```cpp
// ESP32-C3 Mini 引脚配置
#define I2C_SDA_PIN     8    // SDA引脚
#define I2C_SCL_PIN     10   // SCL引脚  
#define BUTTON_PIN      9    // 按钮引脚
#define BUZZER_PIN      2    // 蜂鸣器引脚
#define LED_PIN         3    // 状态LED引脚
#define BATTERY_ADC     0    // 电池电压检测
```

#### 1.3 电源管理系统
- [ ] 实现深度睡眠功能
- [ ] 添加唤醒源配置（按钮中断、运动中断、定时器）
- [ ] 电池电压监测
- [ ] 低电量警告和保护

#### 1.4 基础驱动适配
- [ ] 验证I2C通信稳定性
- [ ] 优化MPU6050驱动
- [ ] 确保OLED显示正常
- [ ] 测试蜂鸣器PWM输出

### 阶段2: 存储系统重构 (1-2周)

#### 2.1 文件系统初始化
- [ ] 集成SPIFFS或LittleFS
- [ ] 创建数据目录结构
```
/data/
├── config.json      # 系统配置
├── daily/           # 每日数据
│   ├── 2025-01-01.json
│   ├── 2025-01-02.json
│   └── ...
├── stats/           # 统计数据
│   └── summary.json
└── logs/            # 系统日志
    └── system.log
```

#### 2.2 数据模型设计
```json
// 每日数据格式 (daily/YYYY-MM-DD.json)
{
  "date": "2025-01-01",
  "sessions": [
    {
      "start_time": "09:30:00",
      "duration": 300,
      "difficulty": "normal",
      "jump_count": 45,
      "calories": 25,
      "max_height": 1.2,
      "avg_frequency": 2.5
    }
  ],
  "daily_total": {
    "total_jumps": 120,
    "total_calories": 68,
    "total_duration": 900,
    "session_count": 3
  }
}
```

#### 2.3 数据管理模块
- [ ] 创建DataManager类
- [ ] 实现数据读写接口
- [ ] 添加数据验证和错误处理
- [ ] 实现7天历史数据查询

### 阶段3: 功能扩展 (2-3周)

#### 3.1 新增游戏功能
- [ ] **难度选择系统**
  - 三档难度：容易(60%)、普通(80%)、困难(100%)
  - 不同难度的跳跃阈值和目标设定
  - 难度选择界面和逻辑

- [ ] **目标计时系统**
  - 可设置运动目标时间
  - 倒计时显示
  - 目标达成提醒

- [ ] **数据统计增强**
  - 实时卡路里计算
  - 跳跃频率分析
  - 运动强度评估

#### 3.2 新增界面功能
- [ ] **历史数据查看界面**
  - 7天数据回顾
  - 趋势图表显示
  - 最佳记录展示

- [ ] **系统设置界面**
  - 音量调节
  - 屏幕亮度
  - 睡眠时间设置
  - 数据清理选项

#### 3.3 用户体验优化
- [ ] **启动优化**
  - 快速启动模式
  - 启动画面优化
  - 状态恢复机制

- [ ] **交互优化**
  - 按钮响应优化
  - 菜单导航改进
  - 操作反馈增强

### 阶段4: 系统优化与测试 (1-2周)

#### 4.1 性能优化
- [ ] 内存使用优化
- [ ] 响应速度提升
- [ ] 电池续航优化
- [ ] 传感器精度调优

#### 4.2 稳定性测试
- [ ] 长时间运行测试
- [ ] 边界条件测试
- [ ] 错误恢复测试
- [ ] 数据完整性验证

#### 4.3 用户测试
- [ ] 功能完整性测试
- [ ] 用户体验测试
- [ ] 性能基准测试
- [ ] 兼容性测试

### 阶段5: 扩展接口预留 (1周)

#### 5.1 通信接口预留
- [ ] Wi-Fi连接框架
- [ ] 蓝牙通信接口
- [ ] 数据同步协议定义

#### 5.2 升级机制预留
- [ ] OTA升级框架
- [ ] 配置文件版本管理
- [ ] 数据迁移机制

## 📁 文件结构规划

### 新增文件结构
```
src/
├── v3/                    # V3.0专用代码
│   ├── power_manager.cpp  # 电源管理
│   ├── data_manager.cpp   # 数据管理
│   ├── file_system.cpp    # 文件系统
│   ├── sleep_manager.cpp  # 睡眠管理
│   └── settings.cpp       # 系统设置
├── ui/                    # 界面相关
│   ├── history_view.cpp   # 历史数据界面
│   ├── settings_view.cpp  # 设置界面
│   └── difficulty_view.cpp # 难度选择界面
└── utils/                 # 工具类
    ├── json_parser.cpp    # JSON解析
    ├── time_utils.cpp     # 时间工具
    └── math_utils.cpp     # 数学工具

include/
├── v3/                    # V3.0头文件
│   ├── power_manager.h
│   ├── data_manager.h
│   ├── file_system.h
│   └── config_v3.h        # V3.0配置
└── ui/
    ├── history_view.h
    └── settings_view.h

data/                      # 数据文件模板
├── config_template.json
└── daily_template.json
```

## 🔄 迁移策略

### 代码迁移
1. **保持V2.0兼容**：创建V3分支，保留V2.0代码
2. **渐进式迁移**：逐模块迁移和测试
3. **接口统一**：保持核心接口不变，内部实现升级

### 数据迁移
1. **格式转换**：提供V2.0到V3.0数据格式转换工具
2. **平滑升级**：支持从V2.0平滑升级到V3.0
3. **备份机制**：升级前自动备份原有数据

## 📈 成功指标

### 功能指标
- [ ] 所有V2.0功能正常工作
- [ ] 新增功能按设计实现
- [ ] 数据持久化稳定可靠
- [ ] 深度睡眠功耗 < 100μA

### 性能指标
- [ ] 启动时间 < 3秒
- [ ] 界面响应时间 < 200ms
- [ ] 电池续航 > 7天（正常使用）
- [ ] 数据读写速度 < 100ms

### 质量指标
- [ ] 代码覆盖率 > 80%
- [ ] 内存使用率 < 70%
- [ ] 无内存泄漏
- [ ] 无严重bug

## 🚀 后续规划

### V3.1 计划功能
- Wi-Fi连接和NTP时间同步
- 简单的数据云端备份
- 基础的远程配置功能

### V3.2 计划功能
- 蓝牙连接手机APP
- 数据可视化图表
- 社交分享功能

### V4.0 愿景
- 完整的IoT生态系统
- 人工智能运动建议
- 多设备数据同步

---

**重构时间预估**: 6-8周
**团队建议**: 2-3人协作开发
**风险评估**: 中等（主要风险在硬件适配和数据迁移）
**优先级**: 高（为项目长期发展奠定基础）
