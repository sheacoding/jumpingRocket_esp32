# 蹦跳小火箭 V2.0 - 问题诊断指南

## 🔍 问题诊断步骤

### 第一步：检查串口输出
烧录新的调试版本并观察串口输出：

```bash
pio run --target upload
pio device monitor
```

### 第二步：分析启动日志

#### 1. 系统信息检查
应该看到：
```
========================================
蹦跳小火箭 V2.0 启动
========================================
ESP32 芯片型号: ESP32-D0WDQ6
芯片版本: 1
CPU频率: 240 MHz
空闲堆内存: XXXXX bytes
```

#### 2. I2C设备扫描结果
**正常情况**：
```
🔍 开始I2C设备扫描...
✅ 发现I2C设备，地址: 0x3C (OLED SSD1306) ⭐
✅ 发现I2C设备，地址: 0x68 (MPU6050) ⭐
✅ 总共发现 2 个I2C设备
🎉 所有关键设备都已找到！
```

**异常情况**：
- 如果显示"❌ 未发现任何I2C设备"，检查硬件连接
- 如果只发现部分设备，检查对应设备的连接

#### 3. OLED初始化检查
**正常情况**：
```
🖥️  显示任务启动
🖥️  开始U8g2 OLED初始化...
✅ OLED I2C连接成功
✅ U8g2库初始化成功
✅ 字体和显示参数设置完成
✅ 清屏测试完成
🎉 U8g2 OLED初始化完全成功
```

**异常情况**：
- "❌ OLED I2C连接失败" → 检查OLED连接
- "❌ U8g2库初始化失败" → 可能是库版本问题

#### 4. MPU6050初始化检查
**正常情况**：
```
🔧 开始Adafruit MPU6050初始化...
✅ MPU6050 I2C连接成功
✅ MPU6050库初始化成功
✅ 传感器测试成功 - 加速度: X=0.12, Y=0.05, Z=9.78 m/s²
```

**异常情况**：
- "❌ MPU6050 I2C连接失败" → 检查MPU6050连接
- "❌ 传感器数据读取测试失败" → 传感器可能损坏

### 第三步：硬件连接验证

#### OLED SSD1306 连接
```
OLED引脚    ESP32引脚
VCC    →    3.3V
GND    →    GND
SCL    →    GPIO22
SDA    →    GPIO21
```

#### MPU6050 连接
```
MPU6050引脚  ESP32引脚
VCC    →    3.3V
GND    →    GND
SCL    →    GPIO22 (与OLED共享)
SDA    →    GPIO21 (与OLED共享)
```

#### 其他硬件
```
按钮：一端 → GPIO2，另一端 → GND
蜂鸣器：正极 → GPIO25，负极 → GND
```

### 第四步：跳跃检测调试

#### 启用详细调试
在sensor.cpp中修改：
```cpp
#define DEBUG_SENSOR_DATA       true    // 启用传感器数据输出
#define DEBUG_JUMP_DETECTION    true    // 启用跳跃检测调试
```

#### 观察跳跃检测日志
**正常跳跃**：
```
🚀 跳跃开始检测，幅值: 1.45 (阈值: 1.30)
📉 跳跃下降阶段，幅值: 0.65 (阈值: 0.70)
✅ 跳跃检测成功！持续时间: 234 ms, 幅值: 0.98
```

**异常情况**：
- 持续显示"⏰ 跳跃检测超时" → 阈值设置不当
- 没有跳跃开始检测 → 阈值过高或传感器无响应
- 跳跃持续时间不符合要求 → 调整时间参数

## 🛠️ 常见问题解决方案

### 问题1：OLED完全黑屏

#### 可能原因和解决方案：

1. **I2C连接问题**
   - 检查SDA/SCL引脚连接
   - 确认3.3V供电（不是5V！）
   - 检查GND连接

2. **I2C地址错误**
   - 大多数SSD1306是0x3C
   - 少数可能是0x3D
   - 查看I2C扫描结果确认

3. **库版本问题**
   - 确认使用U8g2 2.35.9版本
   - 尝试重新安装库

4. **显示器件故障**
   - 更换OLED模块测试
   - 检查焊接质量

### 问题2：跳跃检测持续超时

#### 可能原因和解决方案：

1. **传感器连接问题**
   - 检查MPU6050的I2C连接
   - 确认传感器供电正常

2. **阈值设置不当**
   - 当前设置：高阈值1.3g，低阈值0.7g
   - 可以调整为：高阈值1.1g，低阈值0.8g

3. **传感器方向问题**
   - 确保Z轴垂直向上
   - 检查传感器安装方向

4. **环境干扰**
   - 避免震动环境
   - 确保设备稳定放置

### 问题3：显示任务启动失败

#### 解决方案：
1. 增加任务栈大小
2. 检查内存使用情况
3. 确认任务创建顺序

## 🔧 调试参数调整

### 跳跃检测参数优化
```cpp
// 在sensor.cpp中调整这些值
#define JUMP_THRESHOLD_HIGH     1.1f    // 降低以提高灵敏度
#define JUMP_THRESHOLD_LOW      0.8f    // 提高以减少误触
#define JUMP_MIN_DURATION       30      // 最小持续时间
#define JUMP_MAX_DURATION       1000    // 最大持续时间
#define JUMP_COOLDOWN           150     // 冷却时间
```

### I2C时钟频率调整
```cpp
// 在hardware.cpp中调整
Wire.setClock(50000);  // 降低到50kHz提高稳定性
```

## 📊 性能监控

### 内存使用监控
添加到main.cpp的loop()中：
```cpp
static uint32_t last_memory_check = 0;
if (millis() - last_memory_check >= 10000) {
    Serial.printf("空闲堆内存: %d bytes\n", ESP.getFreeHeap());
    last_memory_check = millis();
}
```

### 任务状态监控
```cpp
// 检查任务是否正常运行
if (uxTaskGetStackHighWaterMark(NULL) < 100) {
    Serial.println("警告：任务栈空间不足");
}
```

## 🎯 预期结果

修复后应该看到：
1. ✅ I2C扫描发现OLED和MPU6050
2. ✅ OLED显示开机动画和测试文本
3. ✅ 传感器数据正常读取
4. ✅ 跳跃检测响应正常
5. ✅ 游戏界面正常显示和切换

如果问题仍然存在，请提供完整的串口输出日志进行进一步分析。
